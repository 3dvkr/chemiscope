<!DOCTYPE html>
<html lang="en" dir="ltr">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1">

        <title>Chemiscope</title>

        <!-- bootstrap -->
        <script src="https://code.jquery.com/jquery-3.4.1.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script>
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
        <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js" integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM" crossorigin="anonymous"></script>

        <!-- JSmol -->
        <script src="https://chemapps.stolaf.edu/jmol/jsmol-2019-10-30/JSmol.min.nojq.js"></script>

        <!-- Pako: zlib implementation in javascript, to store data files as gziped json -->
        <script type="text/javascript" src="pako_inflate.min.js"></script>
    </head>

    <body>
        <header style="padding: 1em 0; margin-bottom: 2em;">
            <h1 style="text-align: center">Chemiscope</h1>
        </header>
        <div class="container">
            <div id=upload-group style="margin: auto; width: 50%; display: grid; grid-gap: 1em; grid-template-columns: 2fr 2fr;">
                <div class="input-group">
                    <input id=upload type="file" class="form-control-file custom-file-input" />
                    <label class="custom-file-label" for=upload>Choose file</label>
                </div>

                <button style="width: 12em;" type="button" class="btn btn-primary" onclick="loadData()">Go!</button>
            </div>

            <div style="height: 2em"></div>
            <div class="alert alert-danger" role="alert" id=error-display style="display: none;">
                <button type="button" class="close" onclick="document.getElementById('error-display').style.display = 'none';">
                    <span aria-hidden="true">&times;</span>
                </button>
                <p></p>
                <details backtrace>

                </details>
            </div>

            <div class="row">
                <div class="col-xl-7">
                    <div id=chemiscope-map style="height: 620px"></div>
                </div>

                <div class="col-xl-5" style="padding: 0;">
                    <div id=chemiscope-structure style="height: 480px;"></div>
                    <div id=chemiscope-info style="min-height: 100px;"></div>
                </div>
            </div>
        </div>
        <div style="margin-bottom: 5em;"></div>
    </body>

    <script type="text/javascript" src="chemiscope.min.js"></script>

    <script>
        let vizualizer = undefined;
        const upload = document.getElementById('upload');
        const load = document.getElementById('load');
        const data = document.getElementById('data');

        upload.onchange = () => {
            upload.nextSibling.nextSibling.innerText = upload.files[0].name.toString();
        }

        function loadData() {
            const reader = new FileReader();
            reader.onload = () => {
                const json = toJson(name, reader.result);
                setupChemiscope(json);
            }
            reader.readAsArrayBuffer(upload.files[0]);
        }

        function toJson(path, buffer) {
            let text;
            if (path.endsWith(".gz")) {
                text = pako.inflate(buffer, {to: "string"});
            } else {
                const decoder = new TextDecoder("utf-8");
                text = decoder.decode(buffer);
            }
            return JSON.parse(text);
        }

        function setupChemiscope(dataset) {
            document.getElementById('upload-group').style.display = "none";

            vizualizer = new Chemiscope.DefaultVizualizer({
                map:       'chemiscope-map',
                info:      'chemiscope-info',
                structure: 'chemiscope-structure',
                j2sPath:   'https://chemapps.stolaf.edu/jmol/jsmol-2019-10-30/j2s/',
            }, dataset)

            vizualizer.structure.settingsPlacement((rect) => {
                const structureRect = document.getElementById('chemiscope-structure').getBoundingClientRect();

                return {
                    top: structureRect.top,
                    left: structureRect.left - rect.width - 25,
                };
            })

            vizualizer.map.settingsPlacement((rect) => {
                const mapRect = document.getElementById('chemiscope-map').getBoundingClientRect();

                return {
                    top: mapRect.top,
                    left: mapRect.left + mapRect.width + 25,
                };
            })
        }

        window.onerror = (msg, url, line, col, error) => {
            const display = document.getElementById('error-display');
            display.style.display = "block";

            const text = error === undefined ? msg : error.toString();
            display.getElementsByTagName('p')[0].innerText = text;
            display.getElementsByTagName('details')[0].innerText = error.stack;
        }

        document.addEventListener('DOMContentLoaded', () => {
            const data = document.getElementById('json-data').innerText.trim();
            if (data !== "") {
                const json = JSON.parse(data);
                setupChemiscope(json)
            }
        })
    </script>
</html>

<!--
HACK: generate-standalone.py will open a script element with id=json-data
below. This allows to concatenate the json file to the standalone HTML file
and automatically load the corresponding dataset. This is NOT standard
compliant in any way (tag outside of <html></html> and un-closed <script> tag),
and rely on the fact that browsers will try very hard to make sense of all
broken HTML they get.
-->
