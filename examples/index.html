<!DOCTYPE html>
<html lang="en" dir="ltr">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1">

        <title>Chemiscope</title>

        <!-- bootstrap -->
        <script src="https://code.jquery.com/jquery-3.4.1.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script>
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
        <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js" integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM" crossorigin="anonymous"></script>

        <!-- JSmol -->
        <script type="text/javascript" src="jsmol/JSmol.min.nojq.js"></script>

        <!-- Pako: zlib implementation in javascript, to store data files as gziped json -->
        <script type="text/javascript" src="pako_inflate.min.js"></script>

        <script defer type="text/javascript" src="sketchviz.min.js"></script>
    </head>

    <body>
        <header style="padding: 1em 0; margin-bottom: 2em;">
            <h1 style="text-align: center">chemiscope visualizer</h1>
        </header>
        <div class="container">
            <div style="margin: auto; width: 90%; display: grid; grid-gap: 1em; grid-template-columns: 2fr 2fr 1fr;">
                <div class="input-group">
                    <div class="input-group-prepend">
                        <label class="input-group-text" for=example>Pick an example</label>
                    </div>
                    <select id=example class="custom-select">
                        <option value="Arginine-Dipeptide.json.gz">Arginine-Dipeptide</option>
                        <option value="CSD.json">Chemical Shieldings</option>
                        <option value="Qm7b.json.gz">Qm7b</option>
                        <option value="Pyrole.json.gz">Pyrole</option>
                    </select>
                </div>

                <div class="input-group">
                    <input id=upload type="file" class="form-control-file custom-file-input" />
                    <label class="custom-file-label" for=upload>Choose file</label>
                </div>

                <button style="width: 12em;" type="button" class="btn btn-primary" id=load>Go!</button>
            </div>

            <div style="height: 2em"></div>
            <div class="alert alert-danger" role="alert" id=error-display style="display: none;">
                <button type="button" class="close" onclick="document.getElementById('error-display').style.display = 'none';">
                    <span aria-hidden="true">&times;</span>
                </button>
                <p></p>
                <details backtrace>

                </details>
            </div>

            <div class="row">
                <div class="col-xl-7">
                    <div id=skviz-plot style="height: 620px"></div>
                </div>

                <div class="col-xl-5" style="padding: 0;">
                    <div id=skviz-viewer style="height: 480px;"></div>
                    <div id=skviz-info style="min-height: 100px;"></div>
                </div>
            </div>
        </div>
        <div style="margin-bottom: 5em;"></div>
    </body>

    <script>
        let vizualizer = undefined;
        const example = document.getElementById('example');
        const upload = document.getElementById('upload');
        const load = document.getElementById('load');

        upload.onchange = () => {
            upload.nextSibling.nextSibling.innerText = upload.files[0].name.toString();
        }

        function loadData() {
            if (upload.value !== "") {
                const name = upload.files[0].name;
                console.log(`loading user file ${name}`);
                const reader = new FileReader();
                reader.onload = () => {
                    const json = toJson(name, reader.result);
                    setupSketchviz(json);
                }
                reader.readAsArrayBuffer(upload.files[0]);
            } else {
                console.log(`loading example file ${example.value}`);
                fetch(example.value)
                    .then(response => response.arrayBuffer())
                    .then(buffer => toJson(example.value, buffer))
                    .then(json => setupSketchviz(json))
                    .catch(e => console.error(e));
            }
        }

        function toJson(path, buffer) {
            let text;
            if (path.endsWith(".gz")) {
                text = pako.inflate(buffer, {to: "string"});
            } else {
                const decoder = new TextDecoder("utf-8");
                text = decoder.decode(buffer);
            }

            // Allow NaN in the JSON file. They are not part of the spec, but
            // Python's json module output them, and they can be usefull.
            return JSON.parse(text.replace(/\bNaN\b/g, '"***NaN***"'), function(key, value) {
                return value === "***NaN***" ? NaN : value;
            });
        }

        function setupSketchviz(json) {
            upload.value = ""
            if (vizualizer !== undefined) {
                vizualizer.changeDataset(json)
            } else {
                vizualizer = new Sketchviz.Vizualizer({
                    ...json,
                    plotId: 'skviz-plot',
                    viewerId: 'skviz-viewer',
                    j2sPath: 'jsmol/j2s',
                    infoId: 'skviz-info',
                })

                vizualizer.viewer.settingsPlacement((rect) => {
                    const viewerRect = document.getElementById('skviz-viewer').getBoundingClientRect();

                    return {
                        top: viewerRect.top,
                        left: viewerRect.left - rect.width - 25,
                    };
                })

                vizualizer.plot.settingsPlacement((rect) => {
                    const viewerRect = document.getElementById('skviz-plot').getBoundingClientRect();

                    return {
                        top: viewerRect.top,
                        left: viewerRect.left + viewerRect.width + 25,
                    };
                })
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            load.onclick = loadData;
            loadData()
        })

        window.onerror = (msg, url, line, col, error) => {
            const display = document.getElementById('error-display');
            display.style.display = "block";

            const text = error === undefined ? msg : error.toString();
            display.getElementsByTagName('p')[0].innerText = text;
            display.getElementsByTagName('details')[0].innerText = error.stack;
        }
    </script>
</html>
